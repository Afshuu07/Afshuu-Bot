const { Client, NoAuth } = require("whatsapp-web.js");
const qrcode = require("qrcode-terminal");
const messageHandler = require("./handlers/messageHandler");
const logger = require("./utils/logger");
const config = require("./config/settings");

class AfshuuBot {
    constructor() {
        this.client = new Client({
            authStrategy: new NoAuth(),
            puppeteer: config.PUPPETEER_OPTIONS,
        });

        this.initializeBot();
    }

    initializeBot() {
        this.client.on("qr", (qr) => {
            console.clear(); // Clear console for better visibility
            console.log("\nüåü‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïêüåü");
            console.log("ü§ñ           AFSHUU BOT SETUP               ü§ñ");
            console.log("üåü‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïêüåü");
            console.log("üì± SCAN THIS QR CODE WITH YOUR WHATSAPP:");
            console.log("üìã INSTRUCTIONS:");
            console.log("   1. Open WhatsApp on your phone");
            console.log("   2. Go to Settings > Linked Devices");
            console.log("   3. Tap 'Link a Device'");
            console.log("   4. Scan the QR code below");
            console.log("\n" + "‚ïê".repeat(50));
            console.log("üì∏ QR CODE - SCAN WITH WHATSAPP CAMERA:");
            console.log("‚ïê".repeat(50));
            
            // Generate larger QR code for better scanning
            qrcode.generate(qr, { small: false });
            
            console.log("‚ïê".repeat(50));
            console.log("‚ö†Ô∏è  TROUBLESHOOTING:");
            console.log("   ‚Ä¢ Make sure your phone has internet connection");
            console.log("   ‚Ä¢ Try moving phone closer/farther from screen");
            console.log("   ‚Ä¢ QR code refreshes every 60 seconds");
            console.log("   ‚Ä¢ If scanning fails, wait for new QR code");
            console.log("üåü‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïêüåü");
            
            logger.info("QR Code generated for authentication");
        });

        this.client.on("ready", () => {
            const readyMessage = `
üéâ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅüéâ
‚ú®            AFSHUU BOT            ‚ú®
üåü          NOW ONLINE!           üåü
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üöÄ Status: Fully Operational
üéµ Audio Downloads: Ready
üõ°Ô∏è  Spam Detection: Active
üëã Auto Welcome: Enabled
üìö Tutorial System: Available

üî• Ready to serve with enhanced features!
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;

            console.log(readyMessage);
            logger.info(
                "Afshuu Bot initialized successfully with enhanced features",
            );

            // Send startup notification to owner if configured
            if (config.OWNER_NUMBER) {
                this.sendStartupNotification();
            }
        });

        this.client.on("authenticated", () => {
            console.log("‚úÖ WhatsApp Web authenticated successfully");
            logger.info("Authentication successful");
        });

        this.client.on("auth_failure", (msg) => {
            console.clear();
            console.error("\nüö® ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê üö®");
            console.error("‚ùå           AUTHENTICATION FAILED           ‚ùå");
            console.error("üö® ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê üö®");
            console.error("üì± REASON:", msg);
            console.error("\nüí° SOLUTIONS:");
            console.error("   1. Wait for new QR code (generating in 5 seconds...)");
            console.error("   2. Make sure WhatsApp is updated");
            console.error("   3. Clear WhatsApp cache if needed");
            console.error("   4. Restart WhatsApp app and try again");
            console.error("üîÑ Bot will generate new QR code automatically...");
            console.error("üö® ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê üö®");
            logger.error("Authentication failed: " + msg);
        });

        this.client.on("disconnected", (reason) => {
            console.log("‚ö†Ô∏è Bot disconnected:", reason);
            logger.warn("Bot disconnected: " + reason);
        });

        this.client.on("message", async (message) => {
            try {
                await messageHandler.handleMessage(this.client, message);
            } catch (error) {
                logger.error("Error handling message: " + error.message);
                console.error("Error handling message:", error);
            }
        });

        this.client.on("message_create", async (message) => {
            // Handle outgoing messages if needed
            if (message.fromMe && message.body.startsWith(".")) {
                try {
                    await messageHandler.handleMessage(this.client, message);
                } catch (error) {
                    logger.error(
                        "Error handling outgoing message: " + error.message,
                    );
                }
            }
        });

        this.client.on("group_join", async (notification) => {
            try {
                const chat = await notification.getChat();
                const contact = await this.client.getContactById(
                    notification.id.participant,
                );

                const welcomeMessages = [
                    `üéä‚ú® *WELCOME TO ${chat.name}!* ‚ú®üéä

üåü Hey there @${contact.id.user}! üåü
üéâ We're thrilled to have you join our amazing community!

üöÄ *What can I do for you?*
üéµ Download audio from YouTube, Spotify & more
üìö Interactive tutorial: Type *.tutorial*
üõ°Ô∏è  Advanced spam protection
üì± Smart group management
üéÆ Fun commands & utilities

üí´ *Quick Start:*
‚Ä¢ *.menu* - See all commands
‚Ä¢ *.tutorial* - Interactive guide
‚Ä¢ *.help* - Get assistance

üî• Let's make this group awesome together!
ü§ñ *Powered by Afshuu Bot*`,

                    `üåà *Welcome Aboard* @${contact.id.user}! üåà

üé≠ You've just entered the coolest group: *${chat.name}*

‚ú® *Your journey begins now:*
üéØ Explore commands with *.menu*
üéì New here? Try *.tutorial* for a guided tour!
üéµ Love music? I can download audio from any platform!
üõ°Ô∏è  Don't worry about spam - I've got your back!

üåü Ready to experience the magic? Let's go! üöÄ`,

                    `üé™ *GRAND ENTRANCE!* üé™
Welcome @${contact.id.user} to *${chat.name}*!

üé® You've unlocked a world of possibilities:
üéß Audio downloads from everywhere
üéØ Smart bot interactions  
üé™ Fun group activities
üõ°Ô∏è  Ultimate protection system

üéÅ *Special for newcomers:*
Type *.tutorial* for your personal guide!
Type *.welcome* to see this message again!

üåü Let the adventure begin! üåü`,
                ];

                const randomWelcome =
                    welcomeMessages[
                        Math.floor(Math.random() * welcomeMessages.length)
                    ];

                await chat.sendMessage(randomWelcome, {
                    mentions: [contact.id._serialized],
                });

                // Send tutorial hint after 5 seconds
                setTimeout(async () => {
                    try {
                        await chat.sendMessage(
                            `üí° *Psst, @${contact.id.user}!* 
                        
Don't forget to check out our interactive tutorial:
üìö Type *.tutorial* to get started!

üéØ Or jump right in with *.menu* to see all commands!`,
                            {
                                mentions: [contact.id._serialized],
                            },
                        );
                    } catch (error) {
                        logger.error(
                            `Error sending tutorial hint: ${error.message}`,
                        );
                    }
                }, 5000);

                logger.info(
                    `Enhanced welcome message sent to ${contact.number || contact.id.user} in group ${chat.name}`,
                );
            } catch (error) {
                logger.error(`Error sending welcome message: ${error.message}`);
            }
        });

        this.client.on("group_leave", (notification) => {
            logger.info(`Someone left group: ${notification.chatId}`);
        });
    }

    async sendStartupNotification() {
        try {
            const contact = await this.client.getContactById(
                config.OWNER_NUMBER + "@c.us",
            );
            await contact.chat.sendMessage(
                "ü§ñ *Afshuu Bot Started*\n\nBot is now online and ready to serve!",
            );
        } catch (error) {
            logger.error(
                "Failed to send startup notification: " + error.message,
            );
        }
    }

    async start() {
        try {
            console.log("üöÄ Starting Afshuu Bot...");

            // Clean up any existing Chromium processes
            await this.cleanupChromeProcesses();

            // Add a small delay before initializing
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            await this.client.initialize();
        } catch (error) {
            console.error("‚ùå Failed to start bot:", error.message);
            logger.error("Failed to start bot: " + error.message);

            // Attempt cleanup before exit
            await this.cleanupChromeProcesses();
            
            // Exit gracefully instead of hard crash
            console.log("üîÑ Bot will attempt restart in 5 seconds...");
            setTimeout(() => {
                process.exit(0);
            }, 5000);
        }
    }

    async cleanupChromeProcesses() {
        try {
            const { exec } = require("child_process");
            await new Promise((resolve) => {
                exec('pkill -f "chromium\\|chrome" || true', () => resolve());
            });

            // Small delay to allow cleanup
            await new Promise((resolve) => setTimeout(resolve, 1000));
        } catch (error) {
            console.log("Cleanup attempt completed");
        }
    }

    async stop() {
        try {
            console.log("üõë Stopping Afshuu Bot...");
            await this.client.destroy();

            // Clean up Chromium processes
            await this.cleanupChromeProcesses();

            logger.info("Bot stopped successfully");
        } catch (error) {
            console.error("Error stopping bot:", error);
            logger.error("Error stopping bot: " + error.message);

            // Force cleanup even if destroy fails
            await this.cleanupChromeProcesses();
        }
    }
}

// Handle process termination
process.on("SIGINT", async () => {
    console.log("\nüì¥ Received SIGINT, shutting down gracefully...");
    if (global.afshuuBot) {
        await global.afshuuBot.stop();
    }
    process.exit(0);
});

process.on("SIGTERM", async () => {
    console.log("\nüì¥ Received SIGTERM, shutting down gracefully...");
    if (global.afshuuBot) {
        await global.afshuuBot.stop();
    }
    process.exit(0);
});

// Start the bot
const bot = new AfshuuBot();
global.afshuuBot = bot;
bot.start().catch(console.error);

module.exports = AfshuuBot;
